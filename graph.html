<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>กราฟแสดงผลคะแนน</title>
    <link rel="stylesheet" href="style.css"/>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <main>
        <h1>คะแนนสะสมของแต่ละบ้าน</h1>
        <p class="instruction"</p>
        <div class="chart-container" style="height:400px; position:relative;">
            <canvas id="scoreChart" style="cursor:pointer;"></canvas>
        </div>
        <a href="index.html" class="back-button">กลับไปหน้ากรอกข้อมูล 📝</a>
    </main>

    <script>
        window.onload = function () {
            const settings = JSON.parse(localStorage.getItem('groupSettings'));
            const allScores = JSON.parse(localStorage.getItem('allScores'));

            if (!settings || !allScores || allScores.length === 0) {
                document.querySelector('main').innerHTML = `
                    <h1>ไม่พบข้อมูล</h1>
                    <p>กรุณากลับไปที่หน้ากรอกข้อมูลเพื่อสร้างกราฟก่อน</p>
                    <a href="index.html" class="back-button">กลับไปหน้ากรอกข้อมูล</a>`;
                return;
            }

            const fullLabels = [];
            const fullDatasets = settings.map(s => ({
                label: s.name,
                borderColor: s.color,
                backgroundColor: s.color + '33',
                data: [],
                tension: 0.1,
                fill: false
            }));

            let cumulativeScores = new Array(settings.length).fill(0);
            for (let i = 0; i < allScores.length; i++) {
                fullLabels.push(`จุดที่ ${i}`);
                allScores[i].forEach((score, j) => {
                    cumulativeScores[j] += score || 0;
                    fullDatasets[j].data.push(cumulativeScores[j]);
                });
            }

            const canvas = document.getElementById('scoreChart');
            const ctx = canvas.getContext('2d');

            const initialData = {
                labels: fullLabels,
                datasets: settings.map(s => ({
                    label: s.name,
                    borderColor: s.color,
                    backgroundColor: s.color + '33',
                    data: new Array(fullLabels.length).fill(null),
                    tension: 0.1,
                    fill: false
                }))
            };

            let currentPoint = -1;

            const myChart = new Chart(ctx, {
                type: 'line',
                data: initialData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 7000,
                        easing: 'easeInOutSine',
                        onComplete: () => {
                            // เมื่อ animation จบจะเรียก animateNextSegment ต่อ
                            animateNextSegment();
                        }
                    },
                    elements: {
                        line: { borderWidth: 3.5 },
                        point: { radius: 4 }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'คะแนนรวมสะสม' }
                        },
                        x: {
                            title: { display: true, text: 'Design By SCiUS KU 14' }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'งานรับน้อง 2568',
                            font: { size: 18 }
                        },
                        legend: { position: 'top' }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'nearest'
                    }
                }
            });

            canvas.style.cursor = 'pointer';

            function animateNextSegment() {
                currentPoint++;
                if (currentPoint >= fullLabels.length) {
                    canvas.style.cursor = 'default';
                    return;
                }

                for (let dsIndex = 0; dsIndex < myChart.data.datasets.length; dsIndex++) {
                    const fullData = fullDatasets[dsIndex].data;
                    myChart.data.datasets[dsIndex].data = fullData.map((val, idx) => {
                        return (idx <= currentPoint) ? val : null;
                    });
                }

                // อัปเดต chart โดยไม่ต้องส่ง onComplete ใหม่ เพราะกำหนดไว้ตอนสร้างแล้ว
                myChart.update();
            }

            canvas.addEventListener('click', () => {
                document.querySelector('.instruction').style.display = 'none';
                canvas.style.cursor = 'default';
                animateNextSegment();
            }, { once: true });
        };
    </script>
</body>
</html>